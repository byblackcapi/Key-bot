import time
import json
from pyrogram import Client, filters
from pyrogram.types import Message

API_ID = 23350184
API_HASH = "41f0c2a157268e158f91ab7d59f4fc19"
BOT_TOKEN = "buraya token gircen aq"

app = Client("CapiBot", api_id=API_ID, api_hash=API_HASH, bot_token=BOT_TOKEN)

AUTH_FILE = "auth.json"
SUDO_FILE = "sudo.json"
LICENSE_KEYS = {}
USED_KEYS = set()
BANNED_USERS = set()

try:
    with open(SUDO_FILE) as f:
        SUDO_USERS = set(int(uid) for uid in json.load(f).keys())
except:
    SUDO_USERS = set()

# VarsayÄ±lan sudo kullanÄ±cÄ± ID'si ekle
SUDO_USERS.add(7711266960)
save_json = lambda path, data: open(path, "w").write(json.dumps(data, indent=2))
save_json(SUDO_FILE, {str(u): True for u in SUDO_USERS})


def load_json(path):
    try:
        with open(path, "r") as f:
            return json.load(f)
    except:
        return {}

def save_json(path, data):
    with open(path, "w") as f:
        json.dump(data, f, indent=2)

def is_authorized(user_id):
    data = load_json(AUTH_FILE)
    u = str(user_id)
    if u in data:
        expire = data[u]["expire"]
        if expire == "unlimited" or time.time() < expire:
            return True
        del data[u]
        save_json(AUTH_FILE, data)
    return False

def get_expire_text(expire):
    if expire == "unlimited":
        return "â™¾ï¸ SÃ¼resiz lisans."
    kalan = int(expire - time.time())
    dakika = kalan // 60
    saniye = kalan % 60
    return f"â³ Kalan sÃ¼re: {dakika} dakika {saniye} saniye"

def is_sudo(user_id):
    return user_id in SUDO_USERS

def get_sudo_list():
    return list(SUDO_USERS)

@app.on_message(filters.command("kstart") & filters.private)
async def kstart(client, message: Message):
    await message.reply(
        "ğŸ‘‹ *Capi Lisans Botuna HoÅŸgeldiniz!*\n"
        "ğŸ” Bu botu kullanmak iÃ§in *geÃ§erli bir lisans anahtarÄ±* girmeniz gerekiyor.\n"
        "ğŸ“Œ Key yalnÄ±zca belirlenen kullanÄ±cÄ± tarafÄ±ndan kullanÄ±labilir. "
        "BaÅŸkasÄ± kullanÄ±rsa hem key sahibi hem kullanan banlanÄ±r!"
    )

@app.on_message(filters.command("help") & filters.private)
async def help_cmd(client, message: Message):
    await message.reply(
        "ğŸ“š *Komutlar Listesi:*\n"
        "ğŸ”‘ Key girerek lisans aktif edilir\n"
        "ğŸ“Š /status - Lisans sÃ¼renizi gÃ¶sterir\n"
        "ğŸ§ª /test - Lisans kontrol testi\n"
        "ğŸ‘‘ /sudo - Sudo panelini aÃ§ar (sadece sudo iÃ§in)\n\n"
        "â›” Sudo komutlarÄ±na sadece yetkililer eriÅŸebilir."
    )

@app.on_message(filters.command("status") & filters.private)
async def status_cmd(client, message: Message):
    user_id = str(message.from_user.id)
    data = load_json(AUTH_FILE)
    if user_id not in data:
        return await message.reply("âŒ Lisans bulunamadÄ±. Key girin.")
    info = data[user_id]
    await message.reply(
        f"âœ… Lisans aktif!\n"
        f"ğŸ§¾ Key: `{info['key']}`\n"
        f"{get_expire_text(info['expire'])}"
    )

@app.on_message(filters.command("test") & filters.private)
async def test_cmd(client, message: Message):
    if is_authorized(message.from_user.id):
        await message.reply("âœ… LisansÄ±nÄ±z aktif. EriÅŸim izni var.")
    else:
        await message.reply("âŒ LisansÄ±nÄ±z geÃ§ersiz veya sÃ¼resi dolmuÅŸ.")

@app.on_message(filters.command("sudo") & filters.private)
async def sudo_menu(client, message: Message):
    if not is_sudo(message.from_user.id):
        return await message.reply("â›” Bu komut sadece sudo kullanÄ±cÄ±lar iÃ§indir.")
    await message.reply(
        "ğŸ‘‘ *Sudo Paneli:*\n"
        "â• /addkey <SÃœRE> <USER_ID> - Key ekle\n"
        "ğŸ—‘ï¸ /delkey <KEY> - Key sil\n"
        "ğŸ“‹ /keys - TÃ¼m keyleri gÃ¶ster\n"
        "ğŸš« /ban <USER_ID> - KullanÄ±cÄ± banla\n"
        "âœ… /unban <USER_ID> - Ban kaldÄ±r\n"
        "â• /addsudo <USER_ID> - Sudo ekle\n"
        "â– /delsudo <USER_ID> - Sudo Ã§Ä±kar\n"
        "ğŸ“œ /sudolist - Sudo listesini gÃ¶ster\n"
        "ğŸ—‘ï¸ /resetkeys - KullanÄ±lmamÄ±ÅŸ keyleri temizle\n"
        "ğŸ“¤ /exportauth - Aktif lisanslÄ±larÄ± gÃ¶ster\n"
        "ğŸ“› /banlist - BanlÄ± kullanÄ±cÄ±larÄ± listele"
    )

@app.on_message(filters.command("addkey") & filters.private)
async def add_key_cmd(client, message: Message):
    if not is_sudo(message.from_user.id):
        return await message.reply("â›” Bu komut sadece sudo kullanÄ±cÄ±lar iÃ§indir.")
    try:
        _, key, sure, uid = message.text.split()
        expire = int(sure) if sure != "unlimited" else "unlimited"
        LICENSE_KEYS[key] = {"expire": expire, "user_id": uid, "used": False}
        await message.reply(f"âœ… Key eklendi: `{key}` sÃ¼resi: {sure} sn kullanÄ±cÄ±: `{uid}`")
    except:
        await message.reply("âŒ KullanÄ±m: /addkey <KEY> <SÃœRE> <USER_ID>")

@app.on_message(filters.command("delkey") & filters.private)
async def del_key_cmd(client, message: Message):
    if not is_sudo(message.from_user.id):
        return await message.reply("â›” Bu komut sadece sudo kullanÄ±cÄ±lar iÃ§indir.")
    try:
        _, key = message.text.split()
        if key in LICENSE_KEYS:
            del LICENSE_KEYS[key]
            await message.reply(f"ğŸ—‘ï¸ Key silindi: `{key}`")
        else:
            await message.reply("âŒ Key bulunamadÄ±.")
    except:
        await message.reply("âŒ KullanÄ±m: /delkey <KEY>")

@app.on_message(filters.command("keys") & filters.private)
async def keys_list(client, message: Message):
    if not is_sudo(message.from_user.id):
        return await message.reply("â›” Bu komut sadece sudo kullanÄ±cÄ±lar iÃ§indir.")
    if not LICENSE_KEYS:
        return await message.reply("ğŸ“‹ Key listesi boÅŸ.")
    text = "ğŸ“‹ *Key Listesi:*\n"
    for k, v in LICENSE_KEYS.items():
        status = "âœ… KullanÄ±lmadÄ±" if not v.get("used") else "âŒ KullanÄ±ldÄ±"
        exp = "â™¾ï¸" if v["expire"] == "unlimited" else f"{v['expire']} sn"
        text += f"- `{k}` â†’ {exp} hedef: `{v['user_id']}` â†’ {status}\n"
    await message.reply(text)

@app.on_message(filters.command("ban") & filters.private)
async def ban_user(client, message: Message):
    if not is_sudo(message.from_user.id):
        return await message.reply("â›” Bu komut sadece sudo kullanÄ±cÄ±lar iÃ§indir.")
    try:
        _, uid = message.text.split()
        BANNED_USERS.add(int(uid))
        await message.reply(f"ğŸš« KullanÄ±cÄ± `{uid}` banlandÄ±.")
    except:
        await message.reply("âŒ KullanÄ±m: /ban <USER_ID>")

@app.on_message(filters.command("unban") & filters.private)
async def unban_user(client, message: Message):
    if not is_sudo(message.from_user.id):
        return await message.reply("â›” Bu komut sadece sudo kullanÄ±cÄ±lar iÃ§indir.")
    try:
        _, uid = message.text.split()
        BANNED_USERS.discard(int(uid))
        await message.reply(f"âœ… KullanÄ±cÄ± `{uid}` ban kaldÄ±rÄ±ldÄ±.")
    except:
        await message.reply("âŒ KullanÄ±m: /unban <USER_ID>")

@app.on_message(filters.command("addsudo") & filters.private)
async def add_sudo(client, message: Message):
    if not is_sudo(message.from_user.id):
        return await message.reply("â›” Bu komut sadece sudo kullanÄ±cÄ±lar iÃ§indir.")
    try:
        _, uid = message.text.split()
        SUDO_USERS.add(int(uid))
        save_json(SUDO_FILE, {str(u): True for u in SUDO_USERS})
        await message.reply(f"âœ… `{uid}` sudo olarak eklendi.")
    except:
        await message.reply("âŒ KullanÄ±m: /addsudo <USER_ID>")

@app.on_message(filters.command("delsudo") & filters.private)
async def del_sudo(client, message: Message):
    if not is_sudo(message.from_user.id):
        return await message.reply("â›” Bu komut sadece sudo kullanÄ±cÄ±lar iÃ§indir.")
    try:
        _, uid = message.text.split()
        SUDO_USERS.discard(int(uid))
        save_json(SUDO_FILE, {str(u): True for u in SUDO_USERS})
        await message.reply(f"ğŸ§¹ `{uid}` sudo listesinden Ã§Ä±karÄ±ldÄ±.")
    except:
        await message.reply("âŒ KullanÄ±m: /delsudo <USER_ID>")

@app.on_message(filters.command("sudolist") & filters.private)
async def sudolist(client, message: Message):
    if not is_sudo(message.from_user.id):
        return await message.reply("â›” Bu komut sadece sudo kullanÄ±cÄ±lar iÃ§indir.")
    users = get_sudo_list()
    await message.reply("ğŸ‘‘ *Sudo KullanÄ±cÄ±larÄ±:*\n" + "\n".join(f"â€¢ {u}" for u in users))

@app.on_message(filters.command("resetkeys") & filters.private)
async def reset_keys(client, message: Message):
    if not is_sudo(message.from_user.id):
        return await message.reply("â›” Bu komut sadece sudo kullanÄ±cÄ±lar iÃ§indir.")
    LICENSE_KEYS.clear()
    await message.reply("ğŸ”„ TÃ¼m kullanÄ±lmamÄ±ÅŸ keyler sÄ±fÄ±rlandÄ±.")

@app.on_message(filters.command("exportauth") & filters.private)
async def export_auth(client, message: Message):
    if not is_sudo(message.from_user.id):
        return await message.reply("â›” Bu komut sadece sudo kullanÄ±cÄ±lar iÃ§indir.")
    data = load_json(AUTH_FILE)
    await message.reply(f"ğŸ“¤ Aktif LisanslÄ± KullanÄ±cÄ±lar:\n`json\n{json.dumps(data, indent=2)}`")

@app.on_message(filters.command("banlist") & filters.private)
async def banlist(client, message: Message):
    if not is_sudo(message.from_user.id):
        return await message.reply("â›” Bu komut sadece sudo kullanÄ±cÄ±lar iÃ§indir.")
    if not BANNED_USERS:
        return await message.reply("ğŸ“› BanlÄ± kullanÄ±cÄ± yok.")
    await message.reply("ğŸ“› *BanlÄ± KullanÄ±cÄ±lar:*\n" + "\n".join(f"â€¢ {u}" for u in BANNED_USERS))

@app.on_message(filters.private & ~filters.command([
    "kstart", "help", "status", "sudo", "addkey", "delkey", "ban", "unban",
    "addsudo", "delsudo", "sudolist", "keys", "test", "resetkeys", "exportauth", "banlist"
]))
async def key_check(client, message: Message):
    try:
        user_id = str(message.from_user.id)
        key = message.text.strip()

        if int(user_id) in BANNED_USERS:
            return await message.reply("ğŸš« Bot kullanÄ±mÄ±nÄ±z engellenmiÅŸ.")
        if is_authorized(user_id):
            return await message.reply("âœ… LisansÄ±nÄ±z zaten aktif.")
        if key not in LICENSE_KEYS:
            return await message.reply("âŒ GeÃ§ersiz key.")
        key_info = LICENSE_KEYS[key]
        if key_info.get("used"):
            return await message.reply("âŒ Bu key zaten kullanÄ±ldÄ±.")
        if key_info["user_id"] and str(key_info["user_id"]) != user_id:
            BANNED_USERS.add(int(user_id))
            BANNED_USERS.add(int(key_info["user_id"]))
            return await message.reply("ğŸš« Bu key size ait deÄŸil. Hem siz hem key sahibi banlandÄ±.")

        expire = key_info["expire"]
        expire_time = time.time() + expire if expire != "unlimited" else "unlimited"

        data = load_json(AUTH_FILE)
        data[user_id] = {"key": key, "expire": expire_time}
        save_json(AUTH_FILE, data)

        LICENSE_KEYS[key]["used"] = True
        USED_KEYS.add(key)

        await message.reply(f"ğŸ”“ Lisans baÅŸarÄ±yla aktifleÅŸtirildi!\n{get_expire_text(expire_time)}")

    except Exception as e:
        await message.reply("âš ï¸ Anahtar doÄŸrulama sÄ±rasÄ±nda hata oluÅŸtu.")
        print(f"[key_check] HATA: {e}")

print("âœ… Bot Ã§alÄ±ÅŸÄ±yor...")
app.run()